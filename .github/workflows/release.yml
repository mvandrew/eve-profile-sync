name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
      - '*.*.*'

jobs:
  build-and-release:
    runs-on: [self-hosted, Windows, X64]
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Extract version from tag
        id: version
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag -match '^v?([0-9]+\.[0-9]+\.[0-9]+)$') {
            $version = $matches[1]
          } else {
            $version = $tag
          }
          Write-Output "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Output "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh
      
      - name: Build Windows x64 binary
        run: |
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          $env:CGO_ENABLED = "0"
          go build -o eve-profile-sync.exe -v
        shell: pwsh
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.version }}
          files: eve-profile-sync.exe
          generate_release_notes: true
          make_latest: true
          # To use Personal Access Token instead, replace GITHUB_TOKEN with PAT_TOKEN:
          # token: ${{ secrets.PAT_TOKEN }}

